<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Tracking</title>

  <!-- Include Leaflet CSS and JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
  <h1>Live Tracking</h1>
  <div id="map" style="height: 400px;"></div>

  <script>
    // Create a Leaflet map centered at a specific location
    const map = L.map('map').setView([0, 0], 13);

    // Add a tile layer (you can choose a different provider)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // Fetch RSSI signals from the server and update the map
    async function fetchRSSI() {
      try {
        const response = await fetch('/rssi');
        const rssiData = await response.json();
        console.log('RSSI data:', rssiData);

        // Clear existing markers
        map.eachLayer(layer => {
          if (layer instanceof L.Marker) {
            map.removeLayer(layer);
          }
        });

        // Add markers for each mobile ESP32
        for (const [deviceAddress, data] of Object.entries(rssiData)) {
          const latestRSSI = data.rssi[data.rssi.length - 1];
          if (latestRSSI !== undefined) {
            // Use RSSI as an approximation for distance and set marker color accordingly
            const markerColor = getMarkerColor(latestRSSI.rssi);
            const marker = L.marker(getRandomLocation()).addTo(map);
            marker.setIcon(getColoredMarkerIcon(markerColor));
            marker.bindPopup(`Device: ${deviceAddress}<br> RSSI: ${latestRSSI.rssi}<br>ESP32 Address: ${latestRSSI.esp32Address}`).openPopup();
          }
        }
      } catch (error) {
        console.error('Error fetching RSSI signals:', error);
      }
    }

    // Fetch RSSI signals every 5 seconds (adjust the interval as needed)
    setInterval(fetchRSSI, 5000);

    // Call fetchRSSI on page load
    fetchRSSI();

    // Function to get a random location (for demonstration purposes)
    function getRandomLocation() {
      const lat = Math.random() * 180 - 90;
      const lng = Math.random() * 360 - 180;
      return [lat, lng];
    }

    // Function to get marker color based on RSSI value
    function getMarkerColor(rssi) {
      // Implement your logic to determine marker color based on RSSI
      // This is a basic example; adjust according to your requirements
      if (rssi > -50) return 'green';
      if (rssi > -70) return 'yellow';
      return 'red';
    }

    // Function to get a colored marker icon
    function getColoredMarkerIcon(color) {
      return new L.Icon({
        iconUrl: `https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
        shadowUrl: 'https://unpkg.com/leaflet/dist/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41],
      });
    }
  </script>
</body>
</html>
